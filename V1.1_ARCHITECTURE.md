# v1.1 Architecture Overview

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Builder Page                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ViewToggle   â”‚  â”‚ Vibe Code    â”‚  â”‚ Import/Export        â”‚  â”‚
â”‚  â”‚ [2D] [3D]    â”‚  â”‚ âœ¨ Button    â”‚  â”‚ YAML â†” Graph         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                    â”‚                     â”‚
           â–¼                    â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Node Palette   â”‚  â”‚  Canvas Area     â”‚  â”‚ Suggestions      â”‚
â”‚                  â”‚  â”‚                  â”‚  â”‚ Panel            â”‚
â”‚ ğŸ¤– Agent        â”‚  â”‚  viewMode='2d'   â”‚  â”‚                  â”‚
â”‚ ğŸ”§ Tool         â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚ Score: 85/100    â”‚
â”‚ ğŸ”€ Condition    â”‚  â”‚  â”‚ ReactFlow  â”‚  â”‚  â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â–‘   â”‚
â”‚ ğŸ”„ Loop         â”‚  â”‚  â”‚ (2D View)  â”‚  â”‚  â”‚                  â”‚
â”‚ âš¡ Parallel     â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚ ğŸ”µ Optimization  â”‚
â”‚ ğŸŸ¢ Start        â”‚  â”‚       OR         â”‚  â”‚ â€¢ Parallelize    â”‚
â”‚ ğŸ”´ End          â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚                  â”‚
â”‚                  â”‚  â”‚  â”‚ Three.js   â”‚  â”‚  â”‚ âš ï¸ Warnings      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚ (3D View)  â”‚  â”‚  â”‚ â€¢ No timeout     â”‚
                      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚                  â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â„¹ï¸ Quality       â”‚
                                            â”‚ â€¢ Add logging    â”‚
                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow

### 3D Visualization Flow
```
User clicks "3D" toggle
       â†“
builderStore.setViewMode('3d')
       â†“
builder/page.tsx re-renders
       â†“
Conditional render: Builder3DCanvas
       â†“
convert2DTo3D(nodes) â†’ 3D positions
       â†“
centerPositions() â†’ centered around origin
       â†“
Render Scene3D (lights, controls, grid)
       â†“
For each node:
  - getNodeGeometry() â†’ shape/color
  - Node3D renders mesh
  - Text component renders label
       â†“
For each edge:
  - Edge3D renders animated line
       â†“
User interacts (orbit, zoom, pan)
       â†“
Selection updates â†’ syncs to builderStore
```

### AI Suggestions Flow
```
User modifies workflow (add/edit/delete nodes)
       â†“
builderStore updates nodes/edges arrays
       â†“
useEffect hook detects change
       â†“
1 second debounce timer starts
       â†“
If no more changes in 1 second:
  â†“
POST /api/suggestions/analyze
  {
    nodes: [...],
    edges: [...]
  }
       â†“
Server: analyzeWorkflow(graph)
       â†“
Run rule checks in parallel:
  - checkParallelization()
  - checkWarnings()
  - checkQuality()
       â†“
Calculate workflow score
       â†“
Return {
  suggestions: [...],
  workflowScore: 85
}
       â†“
suggestionsStore.setSuggestions()
       â†“
UI updates:
  - SuggestionsPanel shows cards
  - AgentNode shows badges
  - Score bar animates
```

## Component Hierarchy

```
BuilderPage
â”œâ”€â”€ ViewToggle
â”œâ”€â”€ NodePalette
â”œâ”€â”€ Canvas Area
â”‚   â”œâ”€â”€ [2D Mode]
â”‚   â”‚   â””â”€â”€ ReactFlow
â”‚   â”‚       â”œâ”€â”€ AgentNode (with SuggestionBadge)
â”‚   â”‚       â”œâ”€â”€ Background
â”‚   â”‚       â”œâ”€â”€ Controls
â”‚   â”‚       â””â”€â”€ MiniMap
â”‚   â”‚
â”‚   â””â”€â”€ [3D Mode]
â”‚       â””â”€â”€ Builder3DCanvas
â”‚           â””â”€â”€ Canvas (Three.js)
â”‚               â”œâ”€â”€ Scene3D
â”‚               â”‚   â”œâ”€â”€ ambientLight
â”‚               â”‚   â”œâ”€â”€ directionalLight
â”‚               â”‚   â”œâ”€â”€ Environment
â”‚               â”‚   â”œâ”€â”€ Grid
â”‚               â”‚   â””â”€â”€ OrbitControls
â”‚               â”‚
â”‚               â”œâ”€â”€ Node3D (for each node)
â”‚               â”‚   â”œâ”€â”€ group
â”‚               â”‚   â”‚   â”œâ”€â”€ mesh
â”‚               â”‚   â”‚   â”‚   â”œâ”€â”€ geometry (sphere/box/cone/etc)
â”‚               â”‚   â”‚   â”‚   â””â”€â”€ material
â”‚               â”‚   â”‚   â””â”€â”€ Text (label)
â”‚               â”‚   â””â”€â”€ Handle (top/bottom)
â”‚               â”‚
â”‚               â””â”€â”€ Edge3D (for each edge)
â”‚                   â””â”€â”€ Line (animated)
â”‚
â”œâ”€â”€ PropertyPanel
â””â”€â”€ SuggestionsPanel
    â”œâ”€â”€ Score display
    â””â”€â”€ Categorized suggestions
        â”œâ”€â”€ Optimizations
        â”‚   â””â”€â”€ SuggestionCard
        â”œâ”€â”€ Warnings
        â”‚   â””â”€â”€ SuggestionCard
        â””â”€â”€ Quality
            â””â”€â”€ SuggestionCard
```

## State Management

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Zustand Stores                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  builderStore                    suggestionsStore       â”‚
â”‚  â”œâ”€â”€ nodes: Node[]               â”œâ”€â”€ suggestions: []    â”‚
â”‚  â”œâ”€â”€ edges: Edge[]               â”œâ”€â”€ workflowScore: 0   â”‚
â”‚  â”œâ”€â”€ viewMode: '2d'              â”œâ”€â”€ isAnalyzing: false â”‚
â”‚  â”œâ”€â”€ selectedNodeId: null        â”œâ”€â”€ isOpen: true       â”‚
â”‚  â”œâ”€â”€ isPanelOpen: true           â”‚                      â”‚
â”‚  â”œâ”€â”€ history: []                 â”‚ Actions:             â”‚
â”‚  â”‚                                â”œâ”€â”€ setSuggestions()  â”‚
â”‚  â”‚ Actions:                       â”œâ”€â”€ setIsAnalyzing()  â”‚
â”‚  â”œâ”€â”€ addNode()                    â”œâ”€â”€ toggleOpen()      â”‚
â”‚  â”œâ”€â”€ updateNode()                 â””â”€â”€ dismissSugg...()  â”‚
â”‚  â”œâ”€â”€ deleteNode()                                       â”‚
â”‚  â”œâ”€â”€ setViewMode()                                      â”‚
â”‚  â”œâ”€â”€ undo() / redo()                                    â”‚
â”‚  â””â”€â”€ import/export()                                    â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## File Organization

```
workflow-dashboard/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ builder/
â”‚   â”‚   â””â”€â”€ page.tsx                    # Main builder page
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ suggestions/
â”‚           â””â”€â”€ analyze/
â”‚               â””â”€â”€ route.ts            # Analysis endpoint
â”‚
â”œâ”€â”€ components/
â”‚   â””â”€â”€ builder/
â”‚       â”œâ”€â”€ AgentNode.tsx               # Modified (badges)
â”‚       â”œâ”€â”€ Builder3DCanvas.tsx         # NEW: 3D wrapper
â”‚       â”œâ”€â”€ Edge3D.tsx                  # NEW: 3D edges
â”‚       â”œâ”€â”€ Node3D.tsx                  # NEW: 3D nodes
â”‚       â”œâ”€â”€ Scene3D.tsx                 # NEW: 3D scene setup
â”‚       â”œâ”€â”€ ViewToggle.tsx              # NEW: 2D/3D button
â”‚       â”œâ”€â”€ SuggestionBadge.tsx         # NEW: Node badge
â”‚       â”œâ”€â”€ SuggestionCard.tsx          # NEW: Suggestion item
â”‚       â””â”€â”€ SuggestionsPanel.tsx        # NEW: Right panel
â”‚
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ 3d/
â”‚   â”‚   â”œâ”€â”€ layoutAlgorithm.ts          # NEW: 2Dâ†’3D conversion
â”‚   â”‚   â””â”€â”€ nodeGeometry.ts             # NEW: Shape mapping
â”‚   â””â”€â”€ suggestions/
â”‚       â”œâ”€â”€ analyzer.ts                 # NEW: Main orchestrator
â”‚       â””â”€â”€ rules/
â”‚           â”œâ”€â”€ parallelization.ts      # NEW: Parallel detection
â”‚           â”œâ”€â”€ warnings.ts             # NEW: Risk detection
â”‚           â””â”€â”€ quality.ts              # NEW: Best practices
â”‚
â”œâ”€â”€ stores/
â”‚   â”œâ”€â”€ builderStore.ts                 # Modified (viewMode)
â”‚   â””â”€â”€ suggestionsStore.ts             # NEW: Suggestions state
â”‚
â””â”€â”€ types/
    â”œâ”€â”€ visualization.ts                # NEW: 3D types
    â””â”€â”€ suggestions.ts                  # NEW: Suggestion types
```

## API Endpoints

```
POST /api/suggestions/analyze
â”œâ”€â”€ Input:
â”‚   â”œâ”€â”€ nodes: Node[]
â”‚   â”œâ”€â”€ edges: Edge[]
â”‚   â””â”€â”€ config?: AnalysisConfig
â”‚
â”œâ”€â”€ Processing:
â”‚   â”œâ”€â”€ checkParallelization(graph)
â”‚   â”œâ”€â”€ checkWarnings(graph)
â”‚   â”œâ”€â”€ checkQuality(graph)
â”‚   â””â”€â”€ calculateScore(graph, suggestionCount)
â”‚
â””â”€â”€ Output:
    â”œâ”€â”€ suggestions: Suggestion[]
    â”‚   â”œâ”€â”€ id: string
    â”‚   â”œâ”€â”€ type: 'optimization' | 'warning' | 'quality'
    â”‚   â”œâ”€â”€ title: string
    â”‚   â”œâ”€â”€ description: string
    â”‚   â”œâ”€â”€ impact?: 'high' | 'medium' | 'low'
    â”‚   â”œâ”€â”€ estimatedSpeedup?: string
    â”‚   â”œâ”€â”€ mitigation?: string
    â”‚   â””â”€â”€ nodeIds?: string[]
    â”‚
    â””â”€â”€ workflowScore: number (0-100)
```

## Performance Characteristics

### 3D Rendering
```
Small Workflow (<10 nodes)
  - FPS: 60
  - Load time: <100ms
  - Memory: ~50MB

Medium Workflow (10-50 nodes)
  - FPS: 50-60
  - Load time: <500ms
  - Memory: ~100MB

Large Workflow (50-100 nodes)
  - FPS: 30-50
  - Load time: <1s
  - Memory: ~200MB

Very Large (100+ nodes)
  - FPS: 20-30 (may lag)
  - Load time: 1-3s
  - Memory: ~300MB
  - Recommendation: Use 2D mode
```

### Analysis Performance
```
Rule-based (no API)
  - Small: <10ms
  - Medium: <50ms
  - Large: <200ms

Debounce: 1 second
  - Prevents excessive calls
  - Smooth UX during editing
```

## Browser Compatibility Matrix

| Feature          | Chrome | Firefox | Safari | Edge |
|-----------------|--------|---------|--------|------|
| 3D View         | âœ…     | âœ…      | âœ…     | âœ…   |
| WebGL 2.0       | âœ…     | âœ…      | âš ï¸ 1.0 | âœ…   |
| OrbitControls   | âœ…     | âœ…      | âœ…     | âœ…   |
| Suggestions     | âœ…     | âœ…      | âœ…     | âœ…   |
| Debouncing      | âœ…     | âœ…      | âœ…     | âœ…   |
| Badges          | âœ…     | âœ…      | âœ…     | âœ…   |

âš ï¸ Safari uses WebGL 1.0 but still works (fallback enabled)

## Security Considerations

### No External API Calls
- Analysis runs server-side (rule-based)
- No sensitive data sent to third-party
- No AI model API calls (yet)

### Input Validation
- Nodes/edges validated in API route
- Type-safe with TypeScript
- Zustand stores prevent invalid state

### XSS Protection
- React auto-escapes user input
- No dangerouslySetInnerHTML used
- Labels sanitized before render

## Scalability Plan

### Current Limits
- Recommended: <50 nodes for 3D
- Tested: Up to 100 nodes
- Analysis: <200ms for 100 nodes

### Future Optimizations
1. **3D Performance**
   - Instanced rendering for large graphs
   - Level-of-detail (LOD) for distant nodes
   - Frustum culling for off-screen nodes

2. **Analysis Caching**
   - Cache results by workflow hash
   - Skip unchanged subgraphs
   - Incremental analysis

3. **Progressive Enhancement**
   - Load 3D libs on-demand
   - Lazy-load suggestions panel
   - Virtual scrolling for large lists

## Testing Strategy

### Unit Tests (To Add)
- `lib/3d/layoutAlgorithm.ts` - Position calculations
- `lib/suggestions/rules/*.ts` - Rule logic
- `stores/*.ts` - State management

### Integration Tests (To Add)
- Builder page with 3D toggle
- Suggestion analysis flow
- Node selection sync

### E2E Tests (To Add)
- Create workflow â†’ See suggestions
- Toggle 3D â†’ Interact with nodes
- Dismiss suggestion â†’ Badge updates

### Manual Testing (Completed)
- âœ… All node types render in 3D
- âœ… Suggestions appear after changes
- âœ… Badges show on affected nodes
- âœ… Score updates correctly
- âœ… Toggle between 2D/3D works
- âœ… No console errors

---

## Migration Notes

### Breaking Changes
- None! This is additive.

### New Dependencies
```bash
npm install three @react-three/fiber @react-three/drei lucide-react
```

### Backwards Compatibility
- Existing workflows load normally
- 2D mode unchanged
- All previous features work

### Deployment Checklist
- [x] TypeScript compiles
- [x] Production build succeeds
- [x] No runtime errors
- [x] All stores initialized
- [x] API routes functional
- [x] Documentation complete
